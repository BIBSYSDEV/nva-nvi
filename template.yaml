AWSTemplateFormatVersion: 2010-09-09
Transform: AWS::Serverless-2016-10-31
Description: >
  AWS

  SAM Template for NVA NVI API
Globals:
  Function:
    Timeout: 20
    Runtime: java21
    Architectures:
      - arm64
    MemorySize: 1536
    Environment:
      Variables:
        BACKEND_CLIENT_AUTH_URL: !Ref CognitoAuthorizationUri
        BACKEND_CLIENT_SECRET_NAME: "BackendCognitoClientCredentials"
        COGNITO_AUTHORIZER_URLS: !Join [",", !Ref CognitoAuthorizerUrls]
        NVI_TABLE_NAME: !Ref NvaNviTable
        SEARCH_INFRASTRUCTURE_API_HOST: !Ref SearchInfrastructureApiHost
        SEARCH_INFRASTRUCTURE_AUTH_URI: !Ref SearchInfrastructureAuthUri
        CUSTOM_DOMAIN_BASE_PATH: !Ref CustomDomainBasePath
        API_HOST: !Ref ApiDomain
        LOG_LEVEL: !Ref LogLevel
  Api:
    Cors:
      AllowMethods: "'PUT, GET,OPTIONS,DELETE,POST'"
      AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,Location'"
      AllowOrigin: "'*'"

Parameters:
  CognitoAuthorizerArn:
    Type: "AWS::SSM::Parameter::Value<String>"
    Description: Reference to Cognito UserPool for the stage
    Default: CognitoAuthorizerArn
  CognitoAuthorizerUrls:
    Type: "AWS::SSM::Parameter::Value<List<String>>"
    Description: Combined URLs of the providers of the Amazon Cognito user pools
    Default: CognitoAuthorizerUrls
  CognitoAuthorizationUri:
    Type: "AWS::SSM::Parameter::Value<String>"
    Default: "/NVA/CognitoUri"
  ApiDomain:
    Type: "AWS::SSM::Parameter::Value<String>"
    Description: The Api domain
    Default: /NVA/ApiDomain
  EventBusName:
    Type: AWS::SSM::Parameter::Value<String>
    Default: /NVA/Events/EventsBusName
  EventBusArn:
    Type: AWS::SSM::Parameter::Value<String>
    Default: /NVA/Events/EventsBusArn
  LogLevel:
    Type: String
    Default: "debug"
    AllowedValues:
      - "trace"
      - "debug"
      - "info"
    Description: Minimum severity for logging. Should be 'info' in production environments.
  ResourcesBucket:
    Type: AWS::SSM::Parameter::Value<String>
    Default: /NVA/Events/PersistedEntriesBucketName
  CristinImportNviQueueArn:
    Type: AWS::SSM::Parameter::Value<String>
    Default: /NVA/Queues/CristinImportNviQueueArn
  SearchInfrastructureApiHost:
    Type: String
    Description: Host of external search infrastructure API (SWS).
    Default: "https://api.sws.aws.sikt.no"
  SearchInfrastructureAuthUri:
    Type: String
    Description: URI to auth for external search infrastructure API (SWS).
    Default: "https://sws-auth.auth.eu-west-1.amazoncognito.com"
  CustomDomainBasePath:
    Type: String
    Description: Base path mapping in CustomDomain
    Default: scientific-index
  Suffix:
    Type: String
    Default: ""
    Description: Suffix used for naming resources for feature branches to avoid conflicts.
  SlackSnsArn:
    Type: AWS::SSM::Parameter::Value<String>
    Default: "/NVA/Monitoring/SlackSnsArn"
  NviDataEntryUpdateCandidateInsertTopicName:
    Type: String
    Default: nvi-data-entry-update-candidate-insert
  NviDataEntryUpdateCandidateApplicableUpdateTopicName:
    Type: String
    Default: nvi-data-entry-update-candidate-applicable-update
  NviDataEntryUpdateCandidateNotApplicableUpdateTopicName:
    Type: String
    Default: nvi-data-entry-update-candidate-not-applicable-update
  NviDataEntryUpdateCandidateRemoveTopicName:
    Type: String
    Default: nvi-data-entry-update-candidate-remove
  NviDataEntryUpdateApprovalInsertTopicName:
    Type: String
    Default: nvi-data-entry-update-approval-insert
  NviDataEntryUpdateApprovalUpdateTopicName:
    Type: String
    Default: nvi-data-entry-update-approval-update
  NviDataEntryUpdateApprovalRemoveTopicName:
    Type: String
    Default: nvi-data-entry-update-approval-remove
  AllowedOrigins:
    Type: String
    Description: comma separated list of external clients that are allowed to contact the HTTP APIs, "*" indicates that all origins are allowed
    Default: "*"
  DefaultTimeoutForParsingLambdas:
    Type: Number
    Description: Timeout in seconds for functions that parse JSON-LD documents. These need a high timeout in order to handle unusually large documents.
    Default: 300 # 5 minutes

Conditions:
  WithSuffix: !Not [!Equals [!Ref Suffix, ""]]

Resources:
  ApiAccessLogGroup:
    Type: AWS::Logs::LogGroup

  InternalBus:
    Type: AWS::Events::EventBus
    Properties:
      Name: !Join ["", ["nvi-internal-bus", !Ref Suffix]]

  #=============================== SNS topics ======================================================
  NviDataEntryUpdateCandidateInsertTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Ref NviDataEntryUpdateCandidateInsertTopicName

  NviDataEntryUpdateCandidateApplicableUpdateTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Ref NviDataEntryUpdateCandidateApplicableUpdateTopicName

  NviDataEntryUpdateCandidateNotApplicableUpdateTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Ref NviDataEntryUpdateCandidateNotApplicableUpdateTopicName

  NviDataEntryUpdateCandidateRemoveTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Ref NviDataEntryUpdateCandidateRemoveTopicName

  NviDataEntryUpdateApprovalInsertTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Ref NviDataEntryUpdateApprovalInsertTopicName

  NviDataEntryUpdateApprovalUpdateTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Ref NviDataEntryUpdateApprovalUpdateTopicName

  NviDataEntryUpdateApprovalRemoveTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Ref NviDataEntryUpdateApprovalRemoveTopicName

  #=============================== SNS subscriptions ======================================================

  #The reason subscriptions are defined seperately, from aws docs:
  #If you specify the Subscription property in the AWS::SNS::Topic resource, and it creates an associated
  #subscription resource, the associated subscription is not deleted when the AWS::SNS::Topic resource is deleted.

  NviDataEntryUpdateCandidateInsertSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Protocol: sqs
      Endpoint: !GetAtt GenerateIndexDocumentQueue.Arn
      TopicArn: !Ref NviDataEntryUpdateCandidateInsertTopic
      RawMessageDelivery: true

  NviDataEntryUpdateCandidateApplicableUpdateSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Protocol: sqs
      Endpoint: !GetAtt GenerateIndexDocumentQueue.Arn
      TopicArn: !Ref NviDataEntryUpdateCandidateApplicableUpdateTopic
      RawMessageDelivery: true

  NviDataEntryUpdateCandidateNotApplicableRemoveFromIndexSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Protocol: sqs
      Endpoint: !GetAtt RemoveDocumentFromIndexQueue.Arn
      TopicArn: !Ref NviDataEntryUpdateCandidateNotApplicableUpdateTopic
      RawMessageDelivery: true

  NviDataEntryUpdateCandidateRemoveFromIndexSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Protocol: sqs
      Endpoint: !GetAtt RemoveDocumentFromIndexQueue.Arn
      TopicArn: !Ref NviDataEntryUpdateCandidateRemoveTopic
      RawMessageDelivery: true

  NviDataEntryUpdateCandidateNotApplicableUpdateSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Protocol: sqs
      Endpoint: !GetAtt GenerateIndexDocumentQueue.Arn
      TopicArn: !Ref NviDataEntryUpdateCandidateNotApplicableUpdateTopic
      RawMessageDelivery: true

  NviDataEntryUpdateCandidateRemoveDeleteDocumentSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Protocol: sqs
      Endpoint: !GetAtt DeletePersistedIndexDocumentQueue.Arn
      TopicArn: !Ref NviDataEntryUpdateCandidateRemoveTopic
      RawMessageDelivery: true

  NviDataEntryUpdateApprovalInsertSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Protocol: sqs
      Endpoint: !GetAtt GenerateIndexDocumentQueue.Arn
      TopicArn: !Ref NviDataEntryUpdateApprovalInsertTopic
      RawMessageDelivery: true

  NviDataEntryUpdateApprovalUpdateSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Protocol: sqs
      Endpoint: !GetAtt GenerateIndexDocumentQueue.Arn
      TopicArn: !Ref NviDataEntryUpdateApprovalUpdateTopic
      RawMessageDelivery: true

  NviDataEntryUpdateApprovalRemoveSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Protocol: sqs
      Endpoint: !GetAtt GenerateIndexDocumentQueue.Arn
      TopicArn: !Ref NviDataEntryUpdateApprovalRemoveTopic
      RawMessageDelivery: true

  #=============================== SQSs ============================================================
  #=============================== For event handling ==============================================
  ResourceEvaluationQueue:
    Type: AWS::SQS::Queue
    Properties:
      VisibilityTimeout: 300
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt EvaluationDLQ.Arn
        maxReceiveCount: 5

  #=============================== Event handling DLQs =============================================
  EvaluationDLQ:
    Type: AWS::SQS::Queue
    Properties:
      MessageRetentionPeriod: 1209600 #14 days
  QueuePersistedResourceDLQ:
    Type: AWS::SQS::Queue
    Properties:
      MessageRetentionPeriod: 1209600 #14 days
  ReEvaluateDLQ:
    Type: AWS::SQS::Queue
    Properties:
      MessageRetentionPeriod: 1209600 #14 days

  #=============================== For batch job processing ======================================
  BatchJobDLQ:
    Type: AWS::SQS::Queue
    Properties:
      MessageRetentionPeriod: 1209600 # 14 days

  BatchJobWorkQueue:
    Type: AWS::SQS::Queue
    Properties:
      VisibilityTimeout: 360 # Should be 6x the function timeout
      MessageRetentionPeriod: 1209600 # 14 days
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt BatchJobDLQ.Arn
        maxReceiveCount: 3

  #=============================== For database events ============================================
  DbEventQueue:
    Type: AWS::SQS::Queue
    Properties:
      VisibilityTimeout: 60
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt DataEntryUpdateDLQ.Arn
        maxReceiveCount: 5
  #=============================== Database event DLQs ============================================
  DynamoDbEventToQueueDLQ:
    Type: AWS::SQS::Queue
    Properties:
      MessageRetentionPeriod: 1209600 #14 days
  DataEntryUpdateDLQ:
    Type: AWS::SQS::Queue
    Properties:
      MessageRetentionPeriod: 1209600 #14 days
  #=============================== For index handling =============================================
  GenerateIndexDocumentQueue:
    Type: AWS::SQS::Queue
    Properties:
      VisibilityTimeout: 60
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt IndexDocumentDLQ.Arn
        maxReceiveCount: 5
  RemoveDocumentFromIndexQueue:
    Type: AWS::SQS::Queue
    Properties:
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt RemoveDocumentFromIndexDLQ.Arn
        maxReceiveCount: 5
  PersistedIndexDocumentQueue:
    Type: AWS::SQS::Queue
    Properties:
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt UpdateIndexDLQ.Arn
        maxReceiveCount: 5
  DeletePersistedIndexDocumentQueue:
    Type: AWS::SQS::Queue
    Properties:
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt DeletePersistedIndexDocumentDLQ.Arn
        maxReceiveCount: 5
  #=============================== Index handling DLQs ============================================
  IndexDLQ:
    Type: AWS::SQS::Queue
    Properties:
      MessageRetentionPeriod: 1209600 #14 days
  IndexDocumentDLQ:
    Type: AWS::SQS::Queue
    Properties:
      MessageRetentionPeriod: 1209600 #14 days
  UpdateIndexDLQ:
    Type: AWS::SQS::Queue
    Properties:
      MessageRetentionPeriod: 1209600 #14 days
  RemoveDocumentFromIndexDLQ:
    Type: AWS::SQS::Queue
    Properties:
      MessageRetentionPeriod: 1209600 #14 days
  DeletePersistedIndexDocumentDLQ:
    Type: AWS::SQS::Queue
    Properties:
      MessageRetentionPeriod: 1209600 #14 days

  #============================= Permissions =======================================================
  BasicWriteLogRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: [lambda.amazonaws.com]
            Action: ["sts:AssumeRole"]
      Policies:
        - PolicyName: writeLog
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:*:*"
  DeletePersistedDocumentRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: [lambda.amazonaws.com]
            Action: ["sts:AssumeRole"]
      Policies:
        - PolicyName: DeletePersistedDocument
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - s3:DeleteObject
                Resource: "*"
        - PolicyName: sqs
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - sqs:SendMessage
                  - sqs:ReceiveMessage
                  - sqs:DeleteMessage
                  - sqs:GetQueueAttributes
                  - sqs:ChangeMessageVisibility
                Resource:
                  - !GetAtt DeletePersistedIndexDocumentDLQ.Arn
                  - !GetAtt DeletePersistedIndexDocumentQueue.Arn
        - PolicyName: subscribeOnSnsTopic
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - sns:Subscribe
                Resource:
                  - !GetAtt DeletePersistedIndexDocumentQueue.Arn
        - PolicyName: writeLog
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:*:*"
  NvaNviRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: [lambda.amazonaws.com]
            Action: ["sts:AssumeRole"]
      Policies:
        - PolicyName: S3Access
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - s3:Get*
                  - s3:List*
                  - s3:PutObject
                  - secretsmanager:*
                Resource: "*"
        - PolicyName: Events
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - events:*
                Resource:
                  - !Ref EventBusArn
                  - !GetAtt InternalBus.Arn
        - PolicyName: writeLog
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:*:*"
        - PolicyName: readSqs
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - sqs:SendMessage
                  - sqs:ReceiveMessage
                  - sqs:DeleteMessage
                  - sqs:GetQueueAttributes
                  - sqs:ChangeMessageVisibility
                Resource:
                  - !GetAtt ResourceEvaluationQueue.Arn
                  - !GetAtt DbEventQueue.Arn
                  - !GetAtt PersistedIndexDocumentQueue.Arn
                  - !GetAtt GenerateIndexDocumentQueue.Arn
                  - !GetAtt RemoveDocumentFromIndexQueue.Arn
                  - !GetAtt RemoveDocumentFromIndexDLQ.Arn
                  - !GetAtt EvaluationDLQ.Arn
                  - !GetAtt UpdateIndexDLQ.Arn
                  - !GetAtt ReEvaluateDLQ.Arn
                  - !GetAtt IndexDLQ.Arn
                  - !GetAtt DynamoDbEventToQueueDLQ.Arn
                  - !GetAtt DataEntryUpdateDLQ.Arn
                  - !GetAtt IndexDocumentDLQ.Arn
                  - !GetAtt DeletePersistedIndexDocumentDLQ.Arn
                  - !GetAtt DeletePersistedIndexDocumentQueue.Arn
                  - !GetAtt QueuePersistedResourceDLQ.Arn
                  - !Ref CristinImportNviQueueArn
                  - !GetAtt BatchJobWorkQueue.Arn
                  - !GetAtt BatchJobDLQ.Arn
        - PolicyName: publishToSnsTopic
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - sns:Publish
                Resource:
                  - !Ref NviDataEntryUpdateCandidateInsertTopic
                  - !Ref NviDataEntryUpdateCandidateApplicableUpdateTopic
                  - !Ref NviDataEntryUpdateCandidateNotApplicableUpdateTopic
                  - !Ref NviDataEntryUpdateCandidateRemoveTopic
                  - !Ref NviDataEntryUpdateApprovalInsertTopic
                  - !Ref NviDataEntryUpdateApprovalUpdateTopic
                  - !Ref NviDataEntryUpdateApprovalRemoveTopic
        - PolicyName: subscribeOnSnsTopic
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - sns:Subscribe
                Resource:
                  - !GetAtt GenerateIndexDocumentQueue.Arn
                  - !GetAtt RemoveDocumentFromIndexQueue.Arn
                  - !GetAtt DeletePersistedIndexDocumentQueue.Arn
        - PolicyName: readSecret
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource: "*"
        - PolicyName: invokeFunction
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - lambda:InvokeFunction
                Resource: "*"
        - PolicyName: crudDynamodb
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:BatchGetItem
                  - dynamodb:BatchWriteItem
                  - dynamodb:ConditionCheckItem
                  - dynamodb:DeleteItem
                  - dynamodb:DescribeLimits
                  - dynamodb:DescribeReservedCapacity
                  - dynamodb:DescribeReservedCapacityOfferings
                  - dynamodb:DescribeTable
                  - dynamodb:GetItem
                  - dynamodb:GetRecords
                  - dynamodb:ListStreams
                  - dynamodb:PutItem
                  - dynamodb:Query
                  - dynamodb:Scan
                  - dynamodb:UpdateItem
                Resource:
                  - !GetAtt NvaNviTable.Arn
        - PolicyName: crudDynamoDbIndex
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:*
                Resource:
                  - !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/nva-nvi-${AWS::StackName}/index/*
        - PolicyName: DynamoDbStreamAccessPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetShardIterator
                  - dynamodb:DescribeStream
                  - dynamodb:ListStreams
                  - dynamodb:GetRecords
                Resource:
                  - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${NvaNviTable}/stream/*"

  GenerateIndexDocumentQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      PolicyDocument:
        Id: MyQueuePolicy
        Version: "2012-10-17"
        Statement:
          - Sid: Allow-SNS-SendMessage
            Effect: Allow
            Principal: "*"
            Action: sqs:SendMessage
            Resource:
              - !GetAtt GenerateIndexDocumentQueue.Arn
            Condition:
              ArnEquals:
                aws:SourceArn:
                  - !Ref NviDataEntryUpdateCandidateInsertTopic
                  - !Ref NviDataEntryUpdateCandidateApplicableUpdateTopic
                  - !Ref NviDataEntryUpdateApprovalInsertTopic
                  - !Ref NviDataEntryUpdateApprovalUpdateTopic
                  - !Ref NviDataEntryUpdateApprovalRemoveTopic
      Queues:
        - !Ref GenerateIndexDocumentQueue

  RemoveDocumentFromIndexQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      PolicyDocument:
        Id: MyQueuePolicy
        Version: "2012-10-17"
        Statement:
          - Sid: Allow-SNS-SendMessage
            Effect: Allow
            Principal: "*"
            Action: sqs:SendMessage
            Resource:
              - !GetAtt RemoveDocumentFromIndexQueue.Arn
            Condition:
              ArnEquals:
                aws:SourceArn:
                  - !Ref NviDataEntryUpdateCandidateNotApplicableUpdateTopic
                  - !Ref NviDataEntryUpdateCandidateRemoveTopic
      Queues:
        - !Ref RemoveDocumentFromIndexQueue

  DeletePersistedIndexDocumentQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      PolicyDocument:
        Id: MyQueuePolicy
        Version: "2012-10-17"
        Statement:
          - Sid: Allow-SNS-SendMessage
            Effect: Allow
            Principal: "*"
            Action: sqs:SendMessage
            Resource:
              - !GetAtt DeletePersistedIndexDocumentQueue.Arn
            Condition:
              ArnEquals:
                aws:SourceArn:
                  - !Ref NviDataEntryUpdateCandidateNotApplicableUpdateTopic
                  - !Ref NviDataEntryUpdateCandidateRemoveTopic
      Queues:
        - !Ref DeletePersistedIndexDocumentQueue

  ReadSearchInfrastructureSecretsPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
            Resource:
              - !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:SearchInfrastructureCredentials-*"

  #============================= API ===============================================================
  ScientificIndexApi:
    Type: AWS::Serverless::Api
    Properties:
      AccessLogSetting:
        DestinationArn: !GetAtt ApiAccessLogGroup.Arn
        Format: '{ "apiId": "$context.apiId", "requestId": "$context.requestId", "requestTime": "$context.requestTime", "requestTimeEpoch": "$context.requestTimeEpoch", "httpMethod": "$context.httpMethod", "path": "$context.path", "status": "$context.status",  "error.message": "$context.error.message" }'
      StageName: Prod
      EndpointConfiguration:
        Type: REGIONAL
      DefinitionBody:
        "Fn::Transform":
          Name: AWS::Include
          Parameters:
            Location: ./docs/openapi.yaml
      BinaryMediaTypes:
        - application/vnd.ms-excel
        - application/vnd.openxmlformats-officedocument.spreadsheetml.sheet

  #===========================BasePathMappings========================================================
  NviBasePathMapping:
    Type: AWS::ApiGateway::BasePathMapping
    Properties:
      BasePath: !If
        - WithSuffix
        - !Sub ${CustomDomainBasePath}-${Suffix}
        - !Sub ${CustomDomainBasePath}
      DomainName: !Ref ApiDomain
      RestApiId: !Ref ScientificIndexApi
      Stage: !Ref ScientificIndexApi.Stage

  #============================= Event Handlers ======================================================
  QueuePersistedResourceHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: event-handlers
      Handler: no.sikt.nva.nvi.events.QueuePersistedResourceHandler::handleRequest
      Role: !GetAtt NvaNviRole.Arn
      Timeout: 30
      MemorySize: 1536
      AutoPublishAlias: live
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          PERSISTED_RESOURCE_QUEUE_URL: !Ref ResourceEvaluationQueue
      Events:
        EventBridgeEvent:
          Type: EventBridgeRule
          Properties:
            EventBusName: !Ref EventBusName
            Pattern:
              detail-type:
                - Lambda Function Invocation Result - Success
              detail:
                responsePayload:
                  topic: ["PublicationService.ExpandedEntry.Persisted"]
      EventInvokeConfig:
        DestinationConfig:
          OnFailure:
            Type: SQS
            Destination: !GetAtt QueuePersistedResourceDLQ.Arn

  EvaluateNVICandidateHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: event-handlers
      Handler: no.sikt.nva.nvi.events.evaluator.EvaluateNviCandidateHandler::handleRequest
      Role: !GetAtt NvaNviRole.Arn
      Timeout: !Ref DefaultTimeoutForParsingLambdas
      MemorySize: 1536
      AutoPublishAlias: live
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          EXPANDED_RESOURCES_BUCKET: !Ref ResourcesBucket
          EVALUATION_DLQ_URL: !Ref EvaluationDLQ
      Events:
        SqsEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt ResourceEvaluationQueue.Arn
            BatchSize: 1
            #Note: EvaluateNVICandidateHandler is implemented to handle only batch size 1.
            #Don't change the batch size value, unless you change the implementation.
      EventInvokeConfig:
        DestinationConfig:
          OnFailure:
            Type: SQS
            Destination: !GetAtt EvaluationDLQ.Arn

  DynamoDbEventToQueueHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: event-handlers
      Handler: no.sikt.nva.nvi.events.db.DynamoDbEventToQueueHandler::handleRequest
      Role: !GetAtt NvaNviRole.Arn
      AutoPublishAlias: live
      SnapStart:
        ApplyOn: PublishedVersions
      Timeout: 60
      Environment:
        Variables:
          DB_EVENTS_QUEUE_URL: !Ref DbEventQueue
          INDEX_DLQ: !Ref IndexDLQ
      Events:
        FanoutSource:
          Type: DynamoDB
          Properties:
            Stream: !GetAtt NvaNviTable.StreamArn
            StartingPosition: TRIM_HORIZON
            BatchSize: 1
            Enabled: true
      EventInvokeConfig:
        DestinationConfig:
          OnFailure:
            Type: SQS
            Destination: !GetAtt DynamoDbEventToQueueDLQ.Arn

  DataEntryUpdateHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: event-handlers
      Handler: no.sikt.nva.nvi.events.db.DataEntryUpdateHandler::handleRequest
      Role: !GetAtt NvaNviRole.Arn
      AutoPublishAlias: live
      SnapStart:
        ApplyOn: PublishedVersions
      Timeout: 60
      Environment:
        Variables:
          TOPIC_CANDIDATE_INSERT: !Ref NviDataEntryUpdateCandidateInsertTopic
          TOPIC_CANDIDATE_APPLICABLE_UPDATE: !Ref NviDataEntryUpdateCandidateApplicableUpdateTopic
          TOPIC_CANDIDATE_NOT_APPLICABLE_UPDATE: !Ref NviDataEntryUpdateCandidateNotApplicableUpdateTopic
          TOPIC_CANDIDATE_REMOVE: !Ref NviDataEntryUpdateCandidateRemoveTopic
          TOPIC_APPROVAL_INSERT: !Ref NviDataEntryUpdateApprovalInsertTopic
          TOPIC_APPROVAL_UPDATE: !Ref NviDataEntryUpdateApprovalUpdateTopic
          TOPIC_APPROVAL_REMOVE: !Ref NviDataEntryUpdateApprovalRemoveTopic
          INDEX_DLQ: !Ref IndexDLQ
      Events:
        SqsEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt DbEventQueue.Arn
      EventInvokeConfig:
        DestinationConfig:
          OnFailure:
            Type: SQS
            Destination: !GetAtt DataEntryUpdateDLQ.Arn

  IndexDocumentHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: index-handlers
      Handler: no.sikt.nva.nvi.index.IndexDocumentHandler::handleRequest
      Role: !GetAtt NvaNviRole.Arn
      AutoPublishAlias: live
      SnapStart:
        ApplyOn: PublishedVersions
      Timeout: 60
      Environment:
        Variables:
          EXPANDED_RESOURCES_BUCKET: !Ref ResourcesBucket
          PERSISTED_INDEX_DOCUMENT_QUEUE_URL: !Ref PersistedIndexDocumentQueue
          INDEX_DLQ: !Ref IndexDLQ
      Events:
        SqsEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt GenerateIndexDocumentQueue.Arn
      EventInvokeConfig:
        DestinationConfig:
          OnFailure:
            Type: SQS
            Destination: !GetAtt IndexDocumentDLQ.Arn

  UpdateIndexHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: index-handlers
      Handler: no.sikt.nva.nvi.index.UpdateIndexHandler::handleRequest
      Role: !GetAtt NvaNviRole.Arn
      AutoPublishAlias: live
      SnapStart:
        ApplyOn: PublishedVersions
      Timeout: 30
      Environment:
        Variables:
          EXPANDED_RESOURCES_BUCKET: !Ref ResourcesBucket
          INDEX_DLQ: !Ref IndexDLQ
      Events:
        SqsEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt PersistedIndexDocumentQueue.Arn
      EventInvokeConfig:
        DestinationConfig:
          OnFailure:
            Type: SQS
            Destination: !GetAtt UpdateIndexDLQ.Arn

  RemoveIndexDocumentHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: index-handlers
      Handler: no.sikt.nva.nvi.index.RemoveIndexDocumentHandler::handleRequest
      Role: !GetAtt NvaNviRole.Arn
      AutoPublishAlias: live
      SnapStart:
        ApplyOn: PublishedVersions
      Timeout: 30
      Events:
        SqsEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt RemoveDocumentFromIndexQueue.Arn
      EventInvokeConfig:
        DestinationConfig:
          OnFailure:
            Type: SQS
            Destination: !GetAtt RemoveDocumentFromIndexDLQ.Arn

  DeletePersistedIndexDocumentHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: index-handlers
      Handler: no.sikt.nva.nvi.index.DeletePersistedIndexDocumentHandler::handleRequest
      Role: !GetAtt DeletePersistedDocumentRole.Arn
      AutoPublishAlias: live
      SnapStart:
        ApplyOn: PublishedVersions
      Timeout: 30
      Environment:
        Variables:
          EXPANDED_RESOURCES_BUCKET: !Ref ResourcesBucket
          INDEX_DLQ: !Ref IndexDLQ
      Events:
        SqsEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt DeletePersistedIndexDocumentQueue.Arn
      EventInvokeConfig:
        DestinationConfig:
          OnFailure:
            Type: SQS
            Destination: !GetAtt DeletePersistedIndexDocumentDLQ.Arn

  CristinNviEventConsumer:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: event-handlers
      Handler: no.sikt.nva.nvi.events.cristin.CristinNviReportEventConsumer::handleRequest
      Role: !GetAtt NvaNviRole.Arn
      Timeout: !Ref DefaultTimeoutForParsingLambdas
      MemorySize: 1536
      Environment:
        Variables:
          EXPANDED_RESOURCES_BUCKET: !Ref ResourcesBucket
      AutoPublishAlias: live
      Events:
        SqsEvent:
          Type: SQS
          Properties:
            Queue: !Ref CristinImportNviQueueArn

  #==========================Manually triggered functions=============================================

  InitHandler:
    Type: AWS::Serverless::Function
    Properties:
      Description: Lambda that creates indices. Needs to be run manually from Test
      CodeUri: index-handlers
      Handler: no.sikt.nva.nvi.index.InitHandler::handleRequest
      Role: !GetAtt NvaNviRole.Arn

  DeleteNviCandidateIndexHandler:
    Type: AWS::Serverless::Function
    Properties:
      Description: Lambda that deletes scientific index. Needs to be run manually from Test
      CodeUri: index-handlers
      Handler: no.sikt.nva.nvi.index.DeleteNviIndexHandler::handleRequest
      Role: !GetAtt NvaNviRole.Arn

  NviRequeueDlqHandler:
    Type: AWS::Serverless::Function
    Properties:
      Description: >
        Lambda that requeues messages from DLQ. Needs to be run manually from Test tab in 
        AWS console. Run with count as parameter to limit number of messages to requeue. Default is 10.
      CodeUri: event-handlers
      Handler: no.sikt.nva.nvi.events.batch.RequeueDlqHandler::handleRequest
      Role: !GetAtt NvaNviRole.Arn
      AutoPublishAlias: live
      Timeout: 300
      Environment:
        Variables:
          DLQ_QUEUE_URL: !Ref IndexDLQ

  BatchReEvaluateNviCandidatesHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: event-handlers
      Handler: no.sikt.nva.nvi.events.batch.ReEvaluateNviCandidatesHandler::handleRequest
      Timeout: 60
      Role: !GetAtt NvaNviRole.Arn
      AutoPublishAlias: live
      Environment:
        Variables:
          EVENT_BUS_NAME: !GetAtt InternalBus.Name
          TOPIC_REEVALUATE_CANDIDATES: "NviService.ReEvaluate"
          PERSISTED_RESOURCE_QUEUE_URL: !Ref ResourceEvaluationQueue
          EXPANDED_RESOURCES_BUCKET: !Ref ResourcesBucket
      Events:
        EventBridgeEvent:
          Type: EventBridgeRule
          Properties:
            EventBusName: !GetAtt InternalBus.Name
            Pattern:
              detail:
                topic: ["NviService.ReEvaluate"]
      EventInvokeConfig:
        DestinationConfig:
          OnFailure:
            Type: SQS
            Destination: !GetAtt ReEvaluateDLQ.Arn

  StartBatchJobHandler:
    Type: AWS::Serverless::Function
    Properties:
      Description: >
        Lambda that initiates batch job processing. Triggered manually from AWS Console with a
        StartBatchJobRequest payload. Supports REFRESH_CANDIDATES, MIGRATE_CANDIDATES, and
        REFRESH_PERIODS job types.
      CodeUri: event-handlers
      Handler: no.sikt.nva.nvi.events.batch.StartBatchJobHandler::handleRequest
      Role: !GetAtt NvaNviRole.Arn
      Timeout: 900
      AutoPublishAlias: live
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          BATCH_JOB_QUEUE_URL: !Ref BatchJobWorkQueue
          EVENT_BUS_NAME: !GetAtt InternalBus.Name
          PROCESSING_ENABLED: "true"
      Events:
        EventBridgeEvent:
          Type: EventBridgeRule
          Properties:
            EventBusName: !GetAtt InternalBus.Name
            Pattern:
              detail-type:
                - NviService.BatchJob.StartBatchJob

  ProcessBatchJobHandler:
    Type: AWS::Serverless::Function
    Properties:
      Description: >
        Lambda that processes individual batch job items from the work queue.
        Uses transactional service methods with optimistic locking to update/refresh database records.
      CodeUri: event-handlers
      Handler: no.sikt.nva.nvi.events.batch.ProcessBatchJobHandler::handleRequest
      Role: !GetAtt NvaNviRole.Arn
      Timeout: 60
      MemorySize: 1024
      AutoPublishAlias: live
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          EXPANDED_RESOURCES_BUCKET: !Ref ResourcesBucket
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt BatchJobWorkQueue.Arn
            BatchSize: 10
            MaximumBatchingWindowInSeconds: 10
            ScalingConfig:
              MaximumConcurrency: 4
            FunctionResponseTypes:
              - ReportBatchItemFailures # Only retry failed messages, not the entire batch

  # ======================= API HANDLERS ========================

  FetchNviCandidateHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: nvi-rest
      Handler: no.sikt.nva.nvi.rest.fetch.FetchNviCandidateHandler::handleRequest
      Role: !GetAtt NvaNviRole.Arn
      Timeout: 600
      MemorySize: 1536
      AutoPublishAlias: live
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          ALLOWED_ORIGIN: !Ref AllowedOrigins
          COGNITO_HOST: !Ref CognitoAuthorizationUri
      Events:
        GetEvent:
          Type: Api
          Properties:
            Path: /candidate/{candidateIdentifier}
            Method: get
            RestApiId: !Ref ScientificIndexApi

  FetchNviCandidateByPublicationIdHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: nvi-rest
      Handler: no.sikt.nva.nvi.rest.fetch.FetchNviCandidateByPublicationIdHandler::handleRequest
      Role: !GetAtt NvaNviRole.Arn
      Timeout: 600
      MemorySize: 1536
      AutoPublishAlias: live
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          ALLOWED_ORIGIN: !Ref AllowedOrigins
      Events:
        GetEvent:
          Type: Api
          Properties:
            Path: /candidate/publication/{candidatePublicationId+}
            Method: get
            RestApiId: !Ref ScientificIndexApi

  FetchReportStatusByPublicationIdHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: nvi-rest
      Handler: no.sikt.nva.nvi.rest.fetch.FetchReportStatusByPublicationIdHandler::handleRequest
      Role: !GetAtt NvaNviRole.Arn
      MemorySize: 1536
      AutoPublishAlias: live
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          ALLOWED_ORIGIN: !Ref AllowedOrigins
      Events:
        GetEvent:
          Type: Api
          Properties:
            Path: /publication/{publicationId}/report-status
            Method: get
            RestApiId: !Ref ScientificIndexApi

  UpdateNviCandidateStatusHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: nvi-rest
      Handler: no.sikt.nva.nvi.rest.upsert.UpdateNviCandidateStatusHandler::handleRequest
      Role: !GetAtt NvaNviRole.Arn
      Timeout: 600
      MemorySize: 1536
      AutoPublishAlias: live
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          ALLOWED_ORIGIN: !Ref AllowedOrigins
          COGNITO_HOST: !Ref CognitoAuthorizationUri
      Events:
        GetEvent:
          Type: Api
          Properties:
            Path: /candidate/{candidateIdentifier}/status
            Method: put
            RestApiId: !Ref ScientificIndexApi

  UpsertAssigneeHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: nvi-rest
      Handler: no.sikt.nva.nvi.rest.upsert.UpsertAssigneeHandler::handleRequest
      Role: !GetAtt NvaNviRole.Arn
      Timeout: 600
      MemorySize: 1536
      AutoPublishAlias: live
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          ALLOWED_ORIGIN: !Ref AllowedOrigins
          COGNITO_HOST: !Ref CognitoAuthorizationUri
      Events:
        GetEvent:
          Type: Api
          Properties:
            Path: /candidate/{candidateIdentifier}/assignee
            Method: put
            RestApiId: !Ref ScientificIndexApi

  CreateNoteHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: nvi-rest
      Handler: no.sikt.nva.nvi.rest.create.CreateNoteHandler::handleRequest
      Role: !GetAtt NvaNviRole.Arn
      Timeout: 600
      MemorySize: 1536
      AutoPublishAlias: live
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          ALLOWED_ORIGIN: !Ref AllowedOrigins
          COGNITO_HOST: !Ref CognitoAuthorizationUri
      Events:
        GetEvent:
          Type: Api
          Properties:
            Path: /candidate/{candidateIdentifier}/note
            Method: post
            RestApiId: !Ref ScientificIndexApi

  RemoveNoteHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: nvi-rest
      Handler: no.sikt.nva.nvi.rest.remove.RemoveNoteHandler::handleRequest
      Role: !GetAtt NvaNviRole.Arn
      Timeout: 600
      MemorySize: 1536
      AutoPublishAlias: live
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          ALLOWED_ORIGIN: !Ref AllowedOrigins
          COGNITO_HOST: !Ref CognitoAuthorizationUri
      Events:
        GetEvent:
          Type: Api
          Properties:
            Path: /candidate/{candidateIdentifier}/note/{noteIdentifier}
            Method: delete
            RestApiId: !Ref ScientificIndexApi

  FetchInstitutionStatusAggregationHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: index-handlers
      Handler: no.sikt.nva.nvi.index.apigateway.FetchInstitutionStatusAggregationHandler::handleRequest
      Role: !GetAtt NvaNviRole.Arn
      Timeout: 600
      MemorySize: 1536
      AutoPublishAlias: live
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          ALLOWED_ORIGIN: !Ref AllowedOrigins
      Events:
        GetEvent:
          Type: Api
          Properties:
            Path: /institution-report/{year}
            Method: get
            RestApiId: !Ref ScientificIndexApi

  FetchReportHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: index-handlers
      Handler: no.sikt.nva.nvi.index.report.FetchReportHandler::handleRequest
      Role: !GetAtt NvaNviRole.Arn
      Timeout: 20
      MemorySize: 1536
      AutoPublishAlias: live
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          ALLOWED_ORIGIN: !Ref AllowedOrigins
      Events:
        AllPeriodsReport:
          Type: Api
          Properties:
            Path: /reports
            Method: get
            RestApiId: !Ref ScientificIndexApi
        PeriodReport:
          Type: Api
          Properties:
            Path: /reports/{period}
            Method: get
            RestApiId: !Ref ScientificIndexApi
        AllInstitutionsReport:
          Type: Api
          Properties:
            Path: /reports/{period}/institutions
            Method: get
            RestApiId: !Ref ScientificIndexApi
        InstitutionReport:
          Type: Api
          Properties:
            Path: /reports/{period}/institutions/{institution}
            Method: get
            RestApiId: !Ref ScientificIndexApi

  FetchInstitutionReportHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: index-handlers
      Handler: no.sikt.nva.nvi.index.apigateway.FetchInstitutionReportHandler::handleRequest
      MemorySize: 1536
      AutoPublishAlias: live
      SnapStart:
        ApplyOn: PublishedVersions
      Timeout: 30
      Environment:
        Variables:
          ALLOWED_ORIGIN: !Ref AllowedOrigins
          COGNITO_HOST: !Ref CognitoAuthorizationUri
          INSTITUTION_REPORT_SEARCH_PAGE_SIZE: 300
      Policies:
        - !GetAtt ReadSearchInfrastructureSecretsPolicy.PolicyArn
      Events:
        GetEvent:
          Type: Api
          Properties:
            Path: /institution-approval-report/{year}
            Method: get
            RestApiId: !Ref ScientificIndexApi

  CreateNviPeriodHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: nvi-rest
      Handler: no.sikt.nva.nvi.rest.create.CreateNviPeriodHandler::handleRequest
      Role: !GetAtt NvaNviRole.Arn
      Timeout: 600
      MemorySize: 1536
      AutoPublishAlias: live
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          ALLOWED_ORIGIN: !Ref AllowedOrigins
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /period
            Method: post
            RestApiId: !Ref ScientificIndexApi

  FetchNviPeriodHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: nvi-rest
      Handler: no.sikt.nva.nvi.rest.fetch.FetchNviPeriodHandler::handleRequest
      Role: !GetAtt NvaNviRole.Arn
      Timeout: 600
      MemorySize: 1536
      AutoPublishAlias: live
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          ALLOWED_ORIGIN: !Ref AllowedOrigins
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /period/{periodIdentifier}
            Method: get
            RestApiId: !Ref ScientificIndexApi

  FetchNviPeriodsHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: nvi-rest
      Handler: no.sikt.nva.nvi.rest.fetch.FetchNviPeriodsHandler::handleRequest
      Role: !GetAtt NvaNviRole.Arn
      Timeout: 600
      MemorySize: 1536
      AutoPublishAlias: live
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          ALLOWED_ORIGIN: !Ref AllowedOrigins
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /period
            Method: get
            RestApiId: !Ref ScientificIndexApi

  UpdateNviPeriodHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: nvi-rest
      Handler: no.sikt.nva.nvi.rest.upsert.UpdateNviPeriodHandler::handleRequest
      Role: !GetAtt NvaNviRole.Arn
      Timeout: 600
      MemorySize: 1536
      AutoPublishAlias: live
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          ALLOWED_ORIGIN: !Ref AllowedOrigins
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /period
            Method: put
            RestApiId: !Ref ScientificIndexApi

  SearchNviCandidatesHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: index-handlers
      Handler: no.sikt.nva.nvi.index.apigateway.SearchNviCandidatesHandler::handleRequest
      Role: !GetAtt NvaNviRole.Arn
      Timeout: 600
      MemorySize: 1536
      AutoPublishAlias: live
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          ALLOWED_ORIGIN: !Ref AllowedOrigins
          COGNITO_HOST: !Ref CognitoAuthorizationUri
      Events:
        GetEvent:
          Type: Api
          Properties:
            Path: /candidate
            Method: get
            RestApiId: !Ref ScientificIndexApi

  FetchNviCandidateContextHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: nvi-rest
      Handler: no.sikt.nva.nvi.rest.fetch.FetchNviCandidateContextHandler::handleRequest
      Role: !GetAtt BasicWriteLogRole.Arn
      Timeout: 600
      MemorySize: 1536
      AutoPublishAlias: live
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          ALLOWED_ORIGIN: !Ref AllowedOrigins
      Events:
        GetEvent:
          Type: Api
          Properties:
            Path: /context
            Method: get
            RestApiId: !Ref ScientificIndexApi

  #============================= Database =========================================================
  NvaNviTable:
    Type: AWS::DynamoDB::Table
    UpdateReplacePolicy: Retain
    DeletionPolicy: Delete
    Properties:
      TableName: !Sub "nva-nvi-${AWS::StackName}"
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: PrimaryKeyHashKey
          AttributeType: S
        - AttributeName: PrimaryKeyRangeKey
          AttributeType: S
        - AttributeName: SecondaryIndex1HashKey
          AttributeType: S
        - AttributeName: SecondaryIndex1RangeKey
          AttributeType: S
        - AttributeName: SearchByYearHashKey
          AttributeType: S
        - AttributeName: SearchByYearRangeKey
          AttributeType: S
      KeySchema:
        - AttributeName: PrimaryKeyHashKey
          KeyType: HASH
        - AttributeName: PrimaryKeyRangeKey
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: SearchByPublicationId
          KeySchema:
            - AttributeName: SecondaryIndex1HashKey
              KeyType: HASH
            - AttributeName: SecondaryIndex1RangeKey
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: SearchByYear
          KeySchema:
            - AttributeName: SearchByYearHashKey
              KeyType: HASH
            - AttributeName: SearchByYearRangeKey
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      Tags:
        - Key: IncludedInBackup
          Value: "true"

  #============================= Alarms =========================================================

  EvaluationDLQAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: NVI evaluating candidacy for resource failed
      AlarmDescription: If this alarm is triggered, then check sqs messages on EvaluationDLQ. Evaluating NVI candidate has failed.
      MetricName: ApproximateNumberOfMessagesVisible
      Namespace: AWS/SQS
      Statistic: Sum
      Dimensions:
        - Name: QueueName
          Value: !GetAtt EvaluationDLQ.QueueName
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      AlarmActions:
        - !Ref SlackSnsArn

  UpdateIndexDLQAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: NVI indexing document failed
      AlarmDescription: If this alarm is triggered, then check sqs messages on UpdateIndexDLQ. Updating index for NVI candidate has failed.
      MetricName: ApproximateNumberOfMessagesVisible
      Namespace: AWS/SQS
      Statistic: Sum
      Dimensions:
        - Name: QueueName
          Value: !GetAtt UpdateIndexDLQ.QueueName
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      AlarmActions:
        - !Ref SlackSnsArn

  DataEntryUpdateDLQAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: NVI DataEntry update failed
      AlarmDescription: If this alarm is triggered, then check sqs messages on DataEntryUpdateDLQ. Proceeding event has failed.
      MetricName: ApproximateNumberOfMessagesVisible
      Namespace: AWS/SQS
      Statistic: Sum
      Dimensions:
        - Name: QueueName
          Value: !GetAtt DataEntryUpdateDLQ.QueueName
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      AlarmActions:
        - !Ref SlackSnsArn

  IndexDLQAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: NVI IndexDLQ threshold exceeded
      AlarmDescription: If this alarm is triggered, then check sqs messages on IndexDLQ. Indexing NVI candidate has failed.
      MetricName: ApproximateNumberOfMessagesVisible
      Namespace: AWS/SQS
      Statistic: Sum
      Dimensions:
        - Name: QueueName
          Value: !GetAtt IndexDLQ.QueueName
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      AlarmActions:
        - !Ref SlackSnsArn

  DynamoDbEventToQueueDLQAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: NVI DynamoDB event failed
      AlarmDescription: If this alarm is triggered, then check sqs messages on DynamoDbEventToQueueDLQ. Proceeding DynamoDB event has failed.
      MetricName: ApproximateNumberOfMessagesVisible
      Namespace: AWS/SQS
      Statistic: Sum
      Dimensions:
        - Name: QueueName
          Value: !GetAtt DynamoDbEventToQueueDLQ.QueueName
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      AlarmActions:
        - !Ref SlackSnsArn

  IndexDocumentDLQAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: NVI creating indexDocument failed
      AlarmDescription: If this alarm is triggered, then check sqs messages on IndexDocumentDLQ. Creating index document for NVI candidate has failed.
      MetricName: ApproximateNumberOfMessagesVisible
      Namespace: AWS/SQS
      Statistic: Sum
      Dimensions:
        - Name: QueueName
          Value: !GetAtt IndexDocumentDLQ.QueueName
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      AlarmActions:
        - !Ref SlackSnsArn

  StartBatchJobErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: NVI StartBatchJob error
      AlarmDescription: Errors in StartBatchJobHandler. Check logs.
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: FunctionName
          Value: !Ref StartBatchJobHandler
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      AlarmActions:
        - !Ref SlackSnsArn

  BatchJobDLQAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: NVI BatchJob failed
      AlarmDescription: Failures during batch job processing. Check messages on BatchJobDLQ.
      MetricName: ApproximateNumberOfMessagesVisible
      Namespace: AWS/SQS
      Statistic: Sum
      Dimensions:
        - Name: QueueName
          Value: !GetAtt BatchJobDLQ.QueueName
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      AlarmActions:
        - !Ref SlackSnsArn
